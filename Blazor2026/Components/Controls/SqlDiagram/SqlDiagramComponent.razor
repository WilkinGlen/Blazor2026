@using Blazor2026.Models
@implements IAsyncDisposable
@namespace Blazor2026.Components.Controls

@if (diagramData != null && diagramData.Tables.Any())
{
    <MudPaper Class="pa-4" Elevation="2">
        <MudText Typo="Typo.h6" Class="mb-3">Database Diagram</MudText>
        
        <MudText Typo="Typo.caption" Class="mb-3" Color="Color.Secondary">
            <MudIcon Icon="@Icons.Material.Filled.TouchApp" Size="Size.Small" /> Drag tables to reposition them
        </MudText>

        <div class="diagram-container" style="position: relative; min-height: 600px; background-color: var(--mud-palette-background-grey); border: 1px solid var(--mud-palette-divider); border-radius: 4px; overflow: auto;">
            <svg width="100%" height="600" style="position: absolute; top: 0; left: 0; pointer-events: none;">
                @foreach (var join in diagramData.Joins)
                {
                    var fromTable = diagramData.Tables.FirstOrDefault(t => t.Alias.Equals(join.FromTable, StringComparison.OrdinalIgnoreCase));
                    var toTable = diagramData.Tables.FirstOrDefault(t => t.Alias.Equals(join.ToTable, StringComparison.OrdinalIgnoreCase));

                    if (fromTable != null && toTable != null)
                    {
                        <line x1="0" y1="0" x2="0" y2="0"
                              stroke="@GetJoinColor(join.JoinType)"
                              stroke-width="2"
                              stroke-linecap="round"
                              marker-end="url(#arrowhead-@join.JoinType.ToLowerInvariant())"
                              data-from-table="@join.FromTable"
                              data-to-table="@join.ToTable"
                              style="opacity: 0; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));" />
                    }
                }

                <defs>
                    @foreach (var joinType in new[] { "INNER", "LEFT", "RIGHT", "FULL", "CROSS" })
                    {
                        <marker id="arrowhead-@joinType.ToLowerInvariant()"
                                markerWidth="10"
                                markerHeight="10"
                                refX="9"
                                refY="3"
                                orient="auto">
                            <polygon points="0 0, 10 3, 0 6"
                                     fill="@GetJoinColor(joinType)" />
                        </marker>
                    }
                </defs>
            </svg>

            @foreach (var table in diagramData.Tables)
            {
                var isCollapsed = IsTableCollapsed(table.Alias);
                <div class="table-box"
                     data-table-id="@table.Alias"
                     style="left: @(table.X)px; top: @(table.Y)px; cursor: grab;">
                    <div class="table-header">
                        <MudIconButton Icon="@(isCollapsed ? Icons.Material.Filled.ExpandMore : Icons.Material.Filled.ExpandLess)"
                                       Size="Size.Small"
                                       Color="Color.Inherit"
                                       OnClick="() => ToggleTableCollapse(table.Alias)"
                                       Style="margin-right: 4px;" />
                        <MudIcon Icon="@Icons.Material.Filled.TableChart" Size="Size.Small" Class="mr-1" />
                        <strong>@table.Name</strong>
                        @if (table.Alias != table.Name)
                        {
                            <span class="table-alias"> (@table.Alias)</span>
                        }
                        @if (isCollapsed)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Text" Style="margin-left: auto;">
                                @table.Columns.Count columns
                            </MudChip>
                        }
                    </div>
                    @if (!isCollapsed)
                    {
                        <div class="table-columns">
                            @foreach (var column in table.Columns)
                            {
                                var isJoinColumn = IsJoinColumn(table.Alias, column);
                                var isSelectedCol = table.SelectedColumns.Contains(column);
                                var tooltip = isJoinColumn && isSelectedCol ? $"Join column (in SELECT) - {column}"
                                    : isJoinColumn ? $"Join column (auto-added) - {column}"
                                    : isSelectedCol ? $"Regular column (in SELECT) - {column}"
                                    : $"Placeholder column - {column}";
                                
                                <div class="column-row">
                                    @if (isJoinColumn && isSelectedCol)
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.Key" Size="Size.Small" Class="mr-1" Color="Color.Success" Title="@tooltip" />
                                    }
                                    else if (isJoinColumn)
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.Key" Size="Size.Small" Class="mr-1" Color="Color.Warning" Title="@tooltip" />
                                    }
                                    else if (isSelectedCol)
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.Circle" Size="Size.Small" Class="mr-1" Color="Color.Default" Style="font-size: 8px;" Title="@tooltip" />
                                    }
                                    else
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.Circle" Size="Size.Small" Class="mr-1" Color="Color.Default" Style="font-size: 8px; opacity: 0.5;" Title="@tooltip" />
                                    }
                                    @column
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    </MudPaper>
}
else if (!string.IsNullOrWhiteSpace(SqlQuery))
{
    <MudAlert Severity="Severity.Info">
        No tables found in the SQL query. Please enter a valid SQL SELECT statement with JOIN clauses.
    </MudAlert>
}
